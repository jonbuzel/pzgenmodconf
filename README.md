# Моды для дадиксервера Zomboid

## Отправная точка для настройки

- вики по установке дадик-сервера [https://pzwiki.net/wiki/Dedicated_server],
- хауту для дадика [https://gist.github.com/jamiemtdwyer/35c8f2aab8e4724d9d7720caefdbf96d],
- хауту для rcon [https://gist.github.com/jamiemtdwyer/e504cd817b97e6d64c574531bb203f18],
- репо со скриптами автоматизации [https://github.com/jamiemtdwyer/pz_scripts/],
- как-то что-то в докер [https://github.com/brenno263/zomboid_server_container] и [https://github.com/cyrale/project-zomboid],
- тот самый велосипед генератор конфига модов по коллекции из стим-воркшопа [https://pzidgrabber.com/],
- в итоге так вот [https://lgsm.vincy.ru/linuxgsm.com/servers/pzserver/index.html].

---
Для build 42 нужна либа из gcc11 и это значит ставить или обновлять на Ubuntu2204.

Что бы перейти на сервер unstable в lgsm нужно внести в конфиг `lgsm/config-lgsm/pzserver/pzserver.cfg` строчку `branch="-beta unstable"`, при этом ломается вызов `./pzserver check-update` (т.е. если использовался в автоматике то нужно отключать) при этом `./pzserver validate` работает корректно; и можно отметить что это только для бинарников zomboid-сервера, моды проверяются и обновляются по другому

```bash
rcon -c $HOME/.rcon/config.yaml checkModsNeedUpdate; sleep 2; \
  grep 'CheckModsNeedUpdate: Mods need update' $HOME/Zomboid/server-console.txt
```

---
`pz_mod_scrab_data_and_generate_ini_for_server.py`

Автоматизации сбора данных о моде по его id для генерации конфига для PZ сервера (в части атрибутов WorkshopItems, Mods, Map) по id списку модов базируется на том факте что:
  
  1. id мода указывается как параметр в url,
  2. существует соглашение что в описании всех модов есть строки с указанием параметров для конфига, определенного вида;

и доколе соблюдены оба эти явления, сея автоматизация худо-бедно отрабатывает (был успешно собран и подобран лист модов для `build 42` с многократными прогонами для поиска и исключения "битых" модов, т.е. это можно практически использовать, но как есть :-)

Генерация значений для атрибутов ini конфига для сервера (работает как для build 41, так и для build 42, но требуется некие ручные изменения в коде скрипта, так как появилось отличие в том, что теперь в 42 требуется указывать в начале '/' для имён модов). Основана на эмпирическом опыте и фольклора из интернетов. Генерируются лишь те самые три атрибута для модов с учётом вложенной зависимостью, возможностью указания входного id-списка ("ids") в виде id-коллекции в стиме (см. на pzidgrabber.com), либо своего ids-файла и параметров в config.json (см. содержание репы :-).

Стоит обратить внимание на возможность как включений, так и исключений (по маске и даже может быть по регекспу) списков в config.json для генерации конфига, так как для некоторых модов важное условие, что бы был указан лишь один из представленных его имен, а так же если нет желания видеть некоторые карты из какого-то мода и что-либо ещё.

Чего здесь нет и скорее всего ни когда не будет, так это проверки модов на конфликты между собой.

ЗЫ. Опытный питонист найдет этот скрипт дурно пахнущим (потому как скрипт составлялся путём склейки и мало-мальского рефакторинга кода представленного ChatGPT 3.5 и 4o). Но он делает работу, которая кому-то может показаться рутинной и однообразной, и к тому же, при ручной обработке по понятным причинам, подверженную ошибкам.

---

`pz_compare_ini.py`

Процедурный скрипт сравнение, для текущего ini конфиг-файла сервера происходит по атрибутам и их составу и выводятся различия между текущим (размещенным файлом) и сгенерированным. (Применение этого юзкейса опытный пользователь найдет самостоятельно :-)

---

Воркфлоу работы с этим скриптом для генерации секций конфига примерно таков:

- Передача списка id модов либо из файла `file_ids_to_config` (в приоритете), либо по id коллекции `collection_id_to_config` (должна быть публична). Т.е. можно начать с готовой коллекции и получив файл со списком `file_ids_collection_to_config` скопировать его на место входного файла, который и будет рабочим списком для коррекции. Либо вариант с внешним csv в гуглдок, который редактируется совместно и формировать уже его и потом из него (кто понял, тот понял :).
- Посоле формирования "своего" листа ids скорее всего потребуется "полировка напильником". Для этого параметры `include` `exclude` `multi_items`, c помощью которых возможно контролировать итоговый конфиг (и скорее всего на этом шаге будут сыпаться ишью стори, кейсы. баги :)
- Различные списки id для получения их метаданных из файла `file_ids_get` и массив `list_ids_get` (из этих списков в моды в конфиг не попадают! только скрабится в папку `output` ака кэш). Требуется для "жанглирования", многократных перезапусков. При этом со временем (особенно при выходе нового билда или очередного обновления, хоть по расписанию) нужно валидировать этот кэш, потому как именно из него в конфиг тянутся id и названия модов, и на данный момент самое простое его дропнуть и скачать заново (при этом можно сверить текущий конфиг на предмет возникших изменений).
- Если имеется текущий сервер со своим наработанным конфигом, то можно с ним сравнивать указав его файл `server_ini` и контролировать отличия и новые изменения (вплоть до их версионирования :), мастхэв при подборе и тестировании связки модов.
